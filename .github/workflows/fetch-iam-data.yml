name: Fetch GCP IAM Data

on:
  schedule:
    # Run daily at 2 AM UTC (10 PM EST / 7 PM PST)
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI
  push:
    branches:
      - main
    paths:
      # Re-run when scraper code changes
      - 'scraper/**'
      - '.github/workflows/fetch-iam-data.yml'

jobs:
  fetch-and-store:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scraper/package-lock.json

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Install dependencies
        working-directory: ./scraper
        run: npm ci

      - name: Build scraper
        working-directory: ./scraper
        run: npm run build

      - name: Run scraper
        working-directory: ./scraper
        run: npm start
        env:
          NODE_ENV: production
          DATA_OUTPUT_DIR: ../data
          LOG_LEVEL: info

      - name: Check for data changes
        id: check_changes
        run: |
          if git diff --quiet data/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            git diff --stat data/
          fi

      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GCP IAM Bot"
          git config user.email "bot@gcpiam.com"
          git add data/
          git commit -m "chore: update IAM data $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iam-data-${{ github.run_number }}
          path: data/
          retention-days: 30

      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'IAM Data Collection Failed',
              body: `Automated GCP IAM data collection workflow failed on ${new Date().toISOString()}\n\nCheck the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['automation', 'bug', 'data-collection']
            });

      - name: Create release on major changes
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const metadata = JSON.parse(fs.readFileSync('data/metadata.json', 'utf8'));

              // Create release if significant changes
              const totalChanges =
                metadata.changesSinceLastRun.rolesAdded.length +
                metadata.changesSinceLastRun.rolesRemoved.length +
                metadata.changesSinceLastRun.rolesModified.length;

              if (totalChanges > 10) {
                const date = new Date().toISOString().split('T')[0];
                await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: `data-${date}`,
                  name: `IAM Data Update - ${metadata.totalRoles} roles, ${metadata.totalPermissions} permissions`,
                  body: `Automated IAM data update\n\n**Summary:**\n- Total Roles: ${metadata.totalRoles}\n- Total Permissions: ${metadata.totalPermissions}\n- Changes: ${totalChanges} (${metadata.changesSinceLastRun.rolesAdded.length} added, ${metadata.changesSinceLastRun.rolesRemoved.length} removed, ${metadata.changesSinceLastRun.rolesModified.length} modified)\n- Updated: ${metadata.lastUpdated}`,
                  draft: false,
                  prerelease: false
                });
              }
            } catch (error) {
              console.log('Could not create release:', error);
            }
